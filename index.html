<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Job Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { notion: { bg: '#FFFFFF', darkbg: '#191919', hover: '#F1F1EF', darkhover: '#282828', border: '#E9E9E7', darkborder: '#2F2F2F', text: '#37352F', darktext: '#D4D4D4', gray: '#787774', darkgray: '#9B9A97' } } } }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .truncate-cell { max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="bg-notion-bg text-notion-text dark:bg-notion-darkbg dark:text-notion-darktext h-screen flex flex-col overflow-hidden">

    <nav class="sticky top-0 z-40 bg-notion-bg/95 dark:bg-notion-darkbg/95 backdrop-blur-sm border-b border-notion-border dark:border-notion-darkborder px-4 py-2 shrink-0">
        <div class="max-w-[1200px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-xl">üíº</span>
                <h1 class="text-lg font-bold">Tracker</h1>
            </div>
            <div class="flex items-center gap-1 md:gap-3">
                <button onclick="exportToPDF()" title="Export PDF" class="p-2 hover:bg-notion-hover dark:hover:bg-notion-darkhover rounded text-notion-gray">üìÑ</button>
                <button onclick="toggleTheme()" class="p-2 hover:bg-notion-hover dark:hover:bg-notion-darkhover rounded">üåó</button>
                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md font-semibold text-sm shadow-sm">+ New</button>
            </div>
        </div>
    </nav>

    <main class="flex-1 overflow-auto p-2 md:p-8">
        <div class="max-w-[1200px] mx-auto border border-notion-border dark:border-notion-darkborder rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-notion-border dark:divide-notion-darkborder">
                <thead class="bg-notion-bg dark:bg-notion-darkbg sticky top-0 z-10">
                    <tr class="text-left text-[10px] md:text-xs text-notion-gray uppercase tracking-wider">
                        <th class="px-3 py-2 border-r dark:border-notion-darkborder">Company</th>
                        <th class="px-3 py-2 border-r dark:border-notion-darkborder">Position</th>
                        <th class="px-3 py-2 border-r dark:border-notion-darkborder">Status</th>
                        <th class="hidden md:table-cell px-3 py-2 border-r dark:border-notion-darkborder">Date</th>
                        <th class="px-3 py-2">Remark</th>
                    </tr>
                </thead>
                <tbody id="job-list" class="divide-y divide-notion-border dark:divide-notion-darkborder">
                    </tbody>
            </table>
        </div>
    </main>

    <footer class="border-t border-notion-border dark:border-notion-darkborder px-4 py-2 text-[10px] text-notion-gray flex justify-between">
        <div>Applications: <span id="f-count">0</span></div>
        <div id="sync-status">‚óè Synced</div>
    </footer>

    <div id="modal" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#202020] w-full max-w-md rounded-xl shadow-2xl p-6">
            <form id="job-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="edit-id">
                <input type="text" id="company" placeholder="Company Name" required class="w-full text-xl font-bold bg-transparent border-b border-gray-200 dark:border-gray-700 py-1 outline-none">
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="position" placeholder="Position" required class="bg-gray-100 dark:bg-notion-darkhover p-2 rounded text-sm">
                    <input type="number" id="salary" placeholder="Salary" class="bg-gray-100 dark:bg-notion-darkhover p-2 rounded text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <select id="status" class="bg-gray-100 dark:bg-notion-darkhover p-2 rounded text-sm">
                        <option value="Applied">Applied</option>
                        <option value="Interviewed">Interviewed</option>
                        <option value="Offer">Offer</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <input type="date" id="date" required class="bg-gray-100 dark:bg-notion-darkhover p-2 rounded text-sm">
                </div>

                <select id="remark" class="w-full bg-gray-100 dark:bg-notion-darkhover p-2 rounded text-sm">
                    <option value="">No Remark</option>
                    <option value="Waiting">Waiting</option>
                    <option value="Declined">Declined</option>
                </select>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="text-sm">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold text-sm">Save Entry</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
            doc, updateDoc, deleteDoc, enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Enable Offline Support
        enableIndexedDbPersistence(db).catch(err => console.error("Offline failed", err));

        const colRef = collection(db, "jobs");
        let activeJobs = []; // Local cache for PDF export and edits

        // GLOBAL HELPERS
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        };

        window.openModal = (id = null) => {
            const form = document.getElementById('job-form');
            form.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('date').valueAsDate = new Date();
            
            if (id) {
                const job = activeJobs.find(j => j.id === id);
                if (job) {
                    document.getElementById('edit-id').value = id;
                    document.getElementById('company').value = job.company;
                    document.getElementById('position').value = job.position;
                    document.getElementById('salary').value = job.salary || "";
                    document.getElementById('status').value = job.status;
                    document.getElementById('date').value = job.date;
                    document.getElementById('remark').value = job.remark || "";
                }
            }
            document.getElementById('modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                company: document.getElementById('company').value,
                position: document.getElementById('position').value,
                salary: document.getElementById('salary').value,
                status: document.getElementById('status').value,
                date: document.getElementById('date').value,
                remark: document.getElementById('remark').value,
                updated: Date.now()
            };

            try {
                if(id) await updateDoc(doc(db, "jobs", id), data);
                else await addDoc(colRef, data);
                closeModal();
            } catch (err) { alert("Save failed: " + err.message); }
        };

        window.deleteJob = async (id) => {
            if(confirm("Delete entry?")) await deleteDoc(doc(db, "jobs", id));
        };

        // REAL-TIME LISTENER
        const q = query(colRef, orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('job-list');
            list.innerHTML = "";
            activeJobs = [];
            
            snapshot.forEach((docSnap) => {
                const job = { id: docSnap.id, ...docSnap.data() };
                activeJobs.push(job);

                const row = `
                <tr class="hover:bg-notion-hover dark:hover:bg-notion-darkhover group text-[11px] md:text-sm">
                    <td class="px-3 py-2 border-r dark:border-notion-darkborder font-medium truncate-cell">üìÑ ${job.company}</td>
                    <td class="px-3 py-2 border-r dark:border-notion-darkborder truncate-cell">${job.position}</td>
                    <td class="px-3 py-2 border-r dark:border-notion-darkborder">
                        <span class="px-1.5 py-0.5 rounded font-bold text-[9px] ${getStatusStyle(job.status)}">${job.status}</span>
                    </td>
                    <td class="hidden md:table-cell px-3 py-2 border-r dark:border-notion-darkborder text-notion-gray">${job.date}</td>
                    <td class="px-3 py-2 flex justify-between items-center">
                        <span class="px-1.5 py-0.5 rounded text-[9px] ${getRemarkStyle(job.remark)}">${job.remark || ''}</span>
                        <div class="opacity-0 group-hover:opacity-100 flex gap-3 ml-2">
                            <button onclick="openModal('${job.id}')">‚úèÔ∏è</button>
                            <button onclick="deleteJob('${job.id}')">üóë</button>
                        </div>
                    </td>
                </tr>`;
                list.innerHTML += row;
            });
            document.getElementById('f-count').innerText = activeJobs.length;
        });

        function getStatusStyle(s) {
            const c = { 'Applied': 'bg-blue-100 text-blue-700', 'Interviewed': 'bg-yellow-100 text-yellow-700', 'Offer': 'bg-purple-100 text-purple-700', 'Rejected': 'bg-red-100 text-red-700' };
            return c[s] || '';
        }
        function getRemarkStyle(r) {
            return r === 'Waiting' ? 'bg-gray-100 text-gray-600' : (r === 'Declined' ? 'bg-pink-100 text-pink-700' : '');
        }

        window.exportToPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const tableData = activeJobs.map(j => [j.company, j.position, j.status, j.date, j.remark || '']);
            doc.text("Job Tracker Report", 14, 15);
            doc.autoTable({ head: [['Company', 'Position', 'Status', 'Date', 'Remark']], body: tableData, startY: 20 });
            doc.save('job-tracker.pdf');
        };

        // Offline PWA Registration
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
    </script>
</body>
</html>
